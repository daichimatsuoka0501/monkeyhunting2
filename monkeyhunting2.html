<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Monkey Hunting Simulation</title>
  <!-- GlowScriptのリソース -->
  <link rel="stylesheet" href="https://www.glowscript.org/css/redmond/2.1/jquery-ui.custom.css">
  <link rel="stylesheet" href="https://www.glowscript.org/css/ide.css">
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery.min.js"></script>
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery-ui.custom.min.js"></script>
  <script src="https://www.glowscript.org/package/glow.3.2.min.js"></script>
  <script src="https://www.glowscript.org/package/RSrun.3.2.min.js"></script>
</head>
<body>
  <div id="glowscript" class="glowscript"></div>
  <script>
    (function() {
      "use strict";
      
      // シミュレーションの初期設定
      var scene = canvas({center: vec(10, 10, 0), width: 800, height: 800, range: 20});
      var g = 9.8; // 重力加速度
      var h = 0.005; // 時間の刻み
      var v0 = 20; // 初速度
      var theta = 30 * Math.PI / 180; // 発射角度（ラジアン）
      var running = false; // 実行状態
      var reset_flag = false; // リセットフラグ
      var t = 0; // 時間
      var L = 20; // モンキーの位置

      // ボールとモンキーの設定
      var ball1 = sphere({pos: vec(0, 0, 0), radius: 0.5, color: color.red, make_trail: true});
      var ball2 = sphere({pos: vec(L, L * Math.tan(theta), 0), radius: 0.5, color: color.blue});

      ball1.vel = vec(v0 * Math.cos(theta), v0 * Math.sin(theta), 0);
      ball2.vel = vec(0, 0, 0);

      // シミュレーションのリセット
      async function reset_simulation() {
        ball1.pos = vec(0, 0, 0);
        ball2.pos = vec(L, L * Math.tan(theta), 0);
        ball1.vel = vec(v0 * Math.cos(theta), v0 * Math.sin(theta), 0);
        ball2.vel = vec(0, 0, 0);
        ball1.clear_trail();
        ball2.clear_trail();
        t = 0;
        running = false;
      }

      // アニメーションループ
      async function animate() {
        while (true) {
          await rate(100);
          if (reset_flag) {
            await reset_simulation();
            reset_flag = false;
          }
          if (running) {
            ball1.pos = ball1.pos.add(ball1.vel.multiply(h));
            ball1.vel = ball1.vel.add(vec(0, -g * h, 0));
            t += h;

            // ボールが地面に到達
            if (ball1.pos.y <= 0) {
              running = false;
              console.log("Simulation ended at t =", t.toFixed(2), "s");
            }

            // ボールとモンキーが接触
            if (mag(ball1.pos.subtract(ball2.pos)) < 0.5) {
              running = false;
              console.log("Hit! at t =", t.toFixed(2), "s");
            }
          }
        }
      }

      // ボタンとスライダーの設定
      var run_button = button({
        text: "Run",
        bind: function() {
          running = !running;
          run_button.text = running ? "Pause" : "Run";
        }
      });

      var reset_button = button({
        text: "Reset",
        bind: function() {
          reset_flag = true;
        }
      });

      scene.append_to_caption("\n");

      var velocity_label = wtext({text: "Initial Velocity: " + v0.toFixed(1) + " m/s"});
      scene.append_to_caption("\n");

      var velocity_slider = slider({
        min: 5,
        max: 40,
        value: v0,
        step: 0.1,
        length: 300,
        bind: function(s) {
          v0 = s.value;
          ball1.vel = vec(v0 * Math.cos(theta), v0 * Math.sin(theta), 0);
          velocity_label.text = "Initial Velocity: " + v0.toFixed(1) + " m/s";
          reset_flag = true;
        }
      });

      scene.append_to_caption("\n");

      var angle_label = wtext({text: "Initial Angle: " + (theta * 180 / Math.PI).toFixed(1) + "°"});
      scene.append_to_caption("\n");

      var angle_slider = slider({
        min: 10,
        max: 50,
        value: theta * 180 / Math.PI,
        step: 1,
        length: 300,
        bind: function(s) {
          theta = s.value * Math.PI / 180;
          ball1.vel = vec(v0 * Math.cos(theta), v0 * Math.sin(theta), 0);
          angle_label.text = "Initial Angle: " + s.value.toFixed(1) + "°";
          reset_flag = true;
        }
      });

      // アニメーションを開始
      animate();
    })();
  </script>
</body>
</html>
