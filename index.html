<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Monkey Hunting Simulation</title>
  <!-- GlowScriptの外部リソース -->
  <link rel="stylesheet" href="https://www.glowscript.org/css/redmond/2.1/jquery-ui.custom.css">
  <link rel="stylesheet" href="https://www.glowscript.org/css/ide.css">
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery.min.js"></script>
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery-ui.custom.min.js"></script>
  <script src="https://www.glowscript.org/package/glow.3.2.min.js"></script>
  <script src="https://www.glowscript.org/package/RSrun.3.2.min.js"></script>
</head>
<body>
  <div id="glowscript" class="glowscript"></div>
  <script>
    (function() {
      "use strict";
      
      // シーンの設定
      var scene = canvas({center: vec(10, 10, 0), width: 800, height: 800, range: 20});

      // グローバル変数
      var g = 9.8;   // 重力加速度
      var h = 0.005; // 時間幅
      var v0 = 20;   // 初期速度
      var theta = 30 * Math.PI / 180; // 初期角度 (ラジアン)
      var running = false;
      var reset_flag = false;
      var t = 0; // 初期時刻
      var L = 20;

      // ボールの設定
      var ball1 = sphere({
        pos: vec(0, 0, 0),
        radius: 0.5,
        color: color.red,
        make_trail: true,
        trail_type: "points",
        interval: 10,
        retain: 100
      });
      var ball2 = sphere({
        radius: 0.5,
        color: color.blue,
        make_trail: true,
        trail_type: "points",
        interval: 10,
        retain: 100
      });

      // ボタンの設定
      function Run(b) {
        running = !running;
        b.text = running ? "Pause" : "Run";
      }

      function reset_animation() {
        reset_flag = true;
      }

      var Run_Pause_button = button({text: "Run", bind: Run});
      var reset_button = button({text: "リセット", bind: reset_animation});
      scene.append_to_caption("\n");

      // 座標軸の描画
      var C = color.white;
      curve({pos: [vec(0, 0, 0), vec(23, 0, 0)], color: C});
      curve({pos: [vec(0, 0, 0), vec(0, 20, 0)], color: C});
      label({pos: vec(0, -2, 0), text: 'O', color: C, height: 20, box: false});
      label({pos: vec(23, -2, 0), text: 'x', color: C, height: 20, box: false});
      label({pos: vec(-2, 20, 0), text: 'y', color: C, height: 20, box: false});

      // スライダーの設定
      function update_velocity(s) {
        v0 = s.value;
        velocity_label.text = `Initial Velocity: ${v0.toFixed(1)} m/s`;
        reset_flag = true;
      }

      function update_angle(s) {
        theta = s.value * Math.PI / 180;
        angle_label.text = `Initial Angle: ${s.value.toFixed(1)}°`;
        reset_flag = true;
      }

      var velocity_label = wtext({text: `Initial Velocity: ${v0.toFixed(1)} m/s`});
      scene.append_to_caption("\n");
      var velocity_slider = slider({
        min: 5, max: 40, value: 20, step: 0.1, length: 300, bind: update_velocity
      });
      scene.append_to_caption("\n");

      var angle_label = wtext({text: `Initial Angle: ${(theta * 180 / Math.PI).toFixed(1)}°`});
      scene.append_to_caption("\n");
      var angle_slider = slider({
        min: 10, max: 50, value: 30, step: 1, length: 300, bind: update_angle
      });
      scene.append_to_caption("\n");

      // 初期設定
      function reset_simulation() {
        ball1.pos = vec(0, 0, 0);
        ball2.pos = vec(L, L * Math.tan(theta), 0);
        ball1.vel = vec(v0 * Math.cos(theta), v0 * Math.sin(theta), 0);
        ball2.vel = vec(0, 0, 0);
        ball1.clear_trail();
        ball2.clear_trail();
        t = 0;
      }

      reset_simulation();

      // アニメーションループ
      async function animate() {
        while (true) {
          await rate(100);

          if (reset_flag) {
            reset_simulation();
            reset_flag = false;
          }

          if (running) {
            ball1.pos = ball1.pos.add(ball1.vel.multiply(h));
            ball1.vel = ball1.vel.add(vec(0, -g * h, 0));
            ball2.pos = ball2.pos.add(ball2.vel.multiply(h));
            ball2.vel = ball2.vel.add(vec(0, -g * h, 0));
            t += h;

            // ボール1とボール2の接触判定
            if (mag(ball1.pos.subtract(ball2.pos)) < 1e-1) {
              running = false;
              if (ball1.pos.y > 0) {
                console.log(`ハント成功！接触時刻: t = ${t.toFixed(2)} s, 接触y座標: ${ball1.pos.y}`);
              } else {
                console.log(`ハント失敗！接触時刻: t = ${t.toFixed(2)} s`);
              }
            }

            // ボール1が地面に到達
            if (ball1.pos.y <= 0) {
              running = false;
              console.log(`ハント失敗！t = ${t.toFixed(2)} s`);
            }
          }
        }
      }

      animate();
    })();
  </script>
</body>
</html>
